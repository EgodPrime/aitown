# 产品需求文档（PRD） — AI 小镇（初版）

版本: 0.1
作者: PM
日期: 2025-10-05

## 一、概述

目标：构建一个在局域网内运行的多人观察型沙盒，玩家可以在浏览器中创建并配置 LLM 驱动的 NPC，观察 NPC 在固定地图中生活、工作与社交。系统以“玩家创造 NPC，观察小镇”为核心互动模式。

重要调整（已由产品决策）：
- 服务器为所有 NPC 提供默认的 OpenAI 兼容 LLM（可配置）；玩家也可以为自己的 NPC 指定自己拥有的 OpenAI 兼容 API（通过安全方式保存在服务器上或由玩家提供的连接字符串）。
- 玩家无权通过前端暂停或继续仿真；小镇时间会持续流逝。仿真暂停/恢复仅由服务器管理员通过命令行工具或管理接口执行。
- 玩家修改 NPC 的 prompt 后，变更不会总是立即反映为行为改变；NPC 会在随时间推进的仿真步中基于新 prompt 逐步调整行为。
- 每个玩家只能拥有且管理一个 NPC，且只能编辑自己的 NPC（边界由会话或玩家标识控制）。
- 前端在 MVP 中可简化为文本驱动的展示：NPC 信息、小镇地点、时间与社交事件均以文本形式呈现，不要求头像或立绘。

背景与动机：本项目旨在展示 LLM 与模拟的结合，提供沉浸式但低交互门槛的体验，适合教育演示、AI 社区实验与本地局域网社交演示。

受众：本地小型用户群（家庭/教育/黑客松参与者），对 AI、模拟与轻量多人体验感兴趣的用户。

成功指标：
- 基本功能可用：用户能创建 NPC、修改其 prompt，并能看到 NPC 在地图上基于 prompt 的行为变化（移动、工作、社交、发言）。
- 稳定运行：在单机/小型局域网环境下，支持 20-50 个 NPC 的同时仿真与消息广播。
- 可演示 LLM 驱动的行为多样性（通过 prompt 可观察不同模式）。

新增成功指标（资源与经济相关）：
- NPC 能够管理基本生存属性（饱食度、能量、心情），这些属性归零将导致 NPC 死亡（仿真中移除/标记）。
- NPC 拥有包裹（inventory）与金钱（currency）系统，能够携带物品并用于购买/消费。
- NPC 能通过工作赚取金钱，且每天会收到服务器发放的基础生存保障金（可配置数量）。

时间与动作速率（成功指标相关）:
- 小镇时间流速：现实世界 36 分钟 = 小镇 1 天（24 小时模拟）。这意味着一天将分配为仿真日轮转周期，管理日结与保障金发放。
- NPC 行动频率：每个 NPC 每 90 秒可执行一次行动（行为决策与执行在该时间点产生并广播状态更新）。

## 二、目标与范围

本 PRD 专注于 MVP（最小可行产品）:
- 服务器为所有 NPC 提供默认 OpenAI 兼容 LLM，玩家可选择性为自己 NPC 提供自有 OpenAI 兼容 API
- 玩家可以在浏览器创建 NPC（每位玩家仅限 1 个）并编辑自己 NPC 的 prompt
- NPC 的行为由后端仿真循环驱动，prompt 更新将在随时间推进的仿真步中生效（非即时必然生效）
- 后端通过 WebSocket 推送文本格式的状态与事件更新（前端以文本方式呈现）

扩展功能（MVP 内涉及但需明确实现方式）:
- NPC 基本属性：每个 NPC 维护饱食度（hunger）、能量（energy）、心情（mood）。这些属性随时间与行为变化降低或提升。若任一关键属性归零，NPC 将死亡并从活动列表中被标记/移除；玩家可以通过删除并重新创建一个 NPC（遵守每玩家一位的规则）来继续参与。
- 经济与物品：NPC 有 `money` 字段与 `inventory`（包裹）；物品（例如食物）可以存放于包裹中，食物消费可以恢复饱食度/能量。金币（money）用于在地点购买物品或服务。
- 工作与保障金：NPC 可以在某些地点（例如餐馆）执行“打工”任务来赚取金钱；此外服务器每天（按仿真日）发放基础生存保障金到每个 NPC 的账户（数量与是否启用可配置）。
- 社交关系：NPC 有社交关系表（social_relations），记录与其他 NPC 的关系（例如 friend, neutral, enemy）以及亲密度分数。关系只会在 NPC 实际相遇或发生交互后建立或改变。
- 地点功能化：小镇包含多种地点（餐馆、市场、广场、工厂等）；每种地点根据性质提供不同功能（例如餐馆可以消费或打工，市场可以买卖物品，广场是社交热点）。

明确不在 MVP 范围内的项（可后续迭代）:
- 用户登录/鉴权
- 永久存储与多机部署（可选 Postgres）
- 商业化特性（付费、社交平台分享等）

## 三、用户故事（示例）

1. 作为一个玩家，我希望在浏览器中创建一个 NPC（仅限一个），并为其设置 prompt，这样我可以观察它在小镇中的行为。
2. 作为一个玩家，我知道我不能暂停/恢复仿真（这是管理员操作），小镇的时间会持续流逝。
3. 作为一个玩家，我希望能修改已创建 NPC 的 prompt，但我理解行为变化基于仿真时间推进逐步生效（非即时保证）。

## 四、MVP 功能列表（高优先级）

4.1 NPC 管理
- 创建 NPC（每位玩家仅能创建 1 个，字段：name, prompt, 初始位置, metadata）
- 列表查看小镇中的所有 NPC（只读）
- 更新 NPC 的 prompt（仅限编辑自己拥有的 NPC）
- 删除 NPC（仅限删除自己拥有的 NPC）

4.1.1 NPC 属性与库存
- 每个 NPC 包含基本生存属性：`hunger`（饱食度）、`energy`（能量）、`mood`（心情）。
- 每个 NPC 包含 `money`（数值）和 `inventory`（物品列表，条目包含 id、name、type、效果等）。
- NPC 死亡规则：任一关键生存属性（如饱食度或能量）降到 0 → NPC 被标记为已死亡并从活动列表中移除；只有玩家或管理员可以重新创建新的 NPC（仍受每玩家 1 个限制）。

4.2 仿真引擎
- 后端周期性为每个 NPC 生成行为（通过 LLM Adapter）并更新其文本化状态/位置
- 状态与事件更新以 WebSocket 文本消息广播给所有客户端
- 仿真全局控制（pause/start）仅限管理员通过命令行或管理接口执行；普通玩家无法通过前端控制仿真速度或暂停

4.2.2 时间与行动节奏
- 小镇时钟：系统应维护仿真时钟，设定为现实时间的比率为 36 分钟 = 1 仿真日，便于日结、工作与地点开放时间的计算。
- 行动间隔：每名 NPC 的决策/行动节奏为 90 秒一次（可配置测试参数），每次行动触发 LLM Adapter 调用并在完成后广播 `state_update`。

4.2.1 生存与经济交互
- 行为决策需考虑基本属性：LLM Adapter 在生成行为时会接收 NPC 的当前 `hunger/energy/mood/money/inventory/social_relations` 作为 context，以便生成更合理的行动（例如去餐馆吃饭、找工作、社交）。
- 物品交互：地点可出售/提供物品（例如食物），购买需消耗 `money`，消费对应影响生存属性。
- 工作行为：某些地点支持 `work` 动作，执行后会在 NPC 的 `money` 增加（工作收益可由地点类型和 NPC 状态影响），同时消耗能量。
- 每日保障金：仿真日轮转时，系统会向每个存活的 NPC 发放基础金额以确保最低生活（可配置）。

4.3 前端展示（MVP 简化为文本风格）
- 前端以文本为主：展示 NPC 列表（名称、所属玩家、prompt 摘要、当前状态文本）
- 小镇地点信息、时间线、社交事件均以时间序列文本或事件流展示
- 创建表单与 prompt 编辑器为简洁文本输入界面（无需头像/立绘）

4.3.1 前端应展示的重要文本信息
- NPC 基本属性：`hunger/energy/mood/money` 与关键物品摘要（例如是否携带食物）
- 时间与日夜周期：展示当前仿真时间、当天是否发放保障金等时间事件
- 地点功能提示：当玩家查看某地点时显示该地点可用动作（例如 buy_food, work_as_waiter）及价格/收益信息
- 社交事件日志：展示 NPC 之间的社交交互摘要（e.g., "A 遇见 B，成为朋友 +5"）

4.5 记忆与日志（NPC 记忆系统）
- 每个 NPC 维护一个按时间顺序的 `memory_log`（记忆日志），记录其每天的关键活动（例如：吃饭、工作、与某 NPC 社交、购买物品等）。
- 记忆保留策略：系统保留清晰记忆为最近 7 天的逐日记录；超过 7 天的历史记忆将由 LLM 按设定的摘要规则压缩为一个摘要条目，用以模拟“模糊的长期记忆”。
- 访问与展示：玩家可以查看自己 NPC 的 `memory_log`（包括逐日记录和长期摘要），日志可用于调试、叙事呈现或作为调试/监督依据。
- 存储与隐私：Memory log 存储为文本事件；若集成持久化，应考虑加密/访问控制（后续迭代）。

4.4 可配置 LLM 适配器
- 提供 mock 实现用于离线演示
- 提供 adapter 接口，便于接入 OpenAI 等

## 五、关键交互与流程（简要）

-- 玩家在前端填写创建表单 → 前端调用 POST /npc（请求需绑定玩家标识）→ 后端创建 NPC（或返回错误当玩家已有 NPC）并广播 npc_created → 所有客户端以文本方式更新界面
-- 后端仿真循环按时调用 LLM Adapter（默认使用服务器端 OpenAI 兼容 API 或玩家指定的 API，具体依配置）→ 更新 NPC 状态/位置并在仿真步中生效 → 广播 state_update
-- 仿真控制（pause/start）仅由管理员通过命令行或受限管理接口发起，普通玩家的 WebSocket `control` 消息将被忽略或返回权限错误

## 六、数据与 API 设计（契约）

参见 `docs/game-spec.md` 中的 NPC 对象与 API 列表。补充 API 要点：

- 创建 NPC 时需包含 `player_id` 或会话标识，服务器据此限制每位玩家只能拥有一个 NPC
- 提供接口以允许玩家上传/注册自己的 OpenAI 兼容 API 连接信息（建议以短期 token 或加密方式存储），服务器在调用该 NPC 的 LLM 时优先使用玩家提供的配置，否则回退到服务器默认 LLM

补充 API 要点（物品、工作、社交相关）:
- GET /places -> 返回小镇地点列表与每个地点可用动作/价格/收益
- POST /npc/{id}/buy -> body: { item_id, place_id }，进行购买并更新 NPC 的 `money` 与 `inventory`
- POST /npc/{id}/use-item -> body: { item_id }，消费物品（例如吃食物）并更新生存属性
- POST /npc/{id}/work -> body: { place_id }，在地点执行工作任务，返回收益和状态变化
- GET /npc/{id}/relations -> 返回该 NPC 的社交关系列表

## 七、验收标准（每项均需可自动/人工验证）

7.1 基本 CRUD
- 创建 NPC：POST /npc（包含 player_id）返回新对象并且 WebSocket 推送 npc_created（验证: 前端文本显示新 NPC）。若玩家已有 NPC，则返回 400/冲突错误。
- 更新 prompt：POST /npc/{id}/prompt（仅允许 NPC 所有者）返回更新对象并且 WebSocket 推送 npc_updated（验证: 前端显示新 prompt，但行为变化基于仿真步而非即时必然生效）
- 删除 NPC：DELETE /npc/{id}（仅允许 NPC 所有者或管理员）返回 200 并且前端移除 NPC

7.1 补充验收（生存、经济、社交）
- 生存属性：创建 NPC，在不干预的情况下观察多日仿真，属性会随时间下降/变化；当 `hunger` 或 `energy` 达到 0 时 NPC 被标记为死亡并广播死亡事件
- 购买与物品：在商店地点购买食物后，消费该食物应恢复指定的 `hunger/energy` 值；购买会消耗 `money` 并把物品加入 `inventory`
- 工作收益与保障金：在工作地点执行 `work` 操作后，NPC 的 `money` 增加（收益合理）；每个仿真日结算时，所有存活 NPC 收到基础保障金并能在日志中看到入账记录
- 社交关系：当两名 NPC 在同一地点相遇时，会生成或更新社交关系（例如 friend 增加亲密度）；社交事件应在前端日志中可见

7.1.1 补充验收（时间与记忆）
- 时间刻度：确认现实 36 分钟等于仿真 1 天（通过观察仿真时钟与日结事件、保障金发放时序来验证）。
- 行动频率：在创建若干 NPC 后，验证每个 NPC 每 90 秒至少进行一次决策/行动并产生 `state_update` 广播（可以通过日志计数验证）。
- 记忆保留：创建 NPC 并运行多日仿真后，验证最近 7 天的逐日事件仍以详细条目保留，超过 7 天的历史以 LLM 摘要条目出现（可通过调用 `GET /npc/{id}/memory` 查看并比对原始事件/摘要）。

7.2 仿真与状态更新
-- 启动后端服务，创建 10 个 NPC，模拟 600 秒内至少出现状态更新（state_update）广播
-- 仿真 pause/start 控制由管理员在服务器端命令行或受限管理接口发起，普通玩家的控制请求不具备权限

7.3 前端展示
- 地图能展示 NPC 节点位置（坐标映射合理）
- 点击或查看 NPC 能看到其当前状态文本

## 八、非功能需求

- 性能：在单台机器上支持 50 个 NPC 并保证每 2 秒更新一次不导致后端明显阻塞。若使用真实 OpenAI API，需考虑调用延迟与并发配额；优先使用批量或并发限制策略并回退到本地规则以保证仿真节奏。
- 可用性：前端在断开重连后能拉取 full_state 并继续渲染
- 可维护性：LLM 适配器应采用插件式设计，便于替换

## 九、风险与缓解措施

- 风险：LLM API 调用延迟或失败 → 缓解：超时回退到本地规则/默认行为；若玩家提供私有 API，需验证其可用性并在失败时回退到服务器 LLM
- 风险：WebSocket 广播成为瓶颈 → 缓解：实施房间/分片广播或使用消息代理

## 十、实施计划（里程碑）

- Week 0: 需求确认与 PRD（当前）
- Week 1: MVP 实现（后端仿真、API、前端可视化）
- Week 2: LLM Adapter 插件化、简单持久化
- Week 3: 前端增强（编辑、交互、UI 改进）

## 十一、开放问题（需要 PO/PM 确认）

1. 是否需要社交登录或多人协作的编辑权限控制？
2. 是否允许玩家导入/导出 NPC 配置？
3. 是否需要内置示例 prompt 库供新手使用？

---

现在我将把一个关键交互段（"MVP 功能列表 & 验收标准"）置于 elicit 交互：我会给出 1-9 的选项来帮助你细化 MVP 的部分（例如是否启用删除 NPC、是否需要示例 prompt、更新频率等）。

Advanced Elicitation Options
Choose a number (0-8) or 9 to proceed:

0. Expand or Contract for Audience
1. Critique and Refine
2. Identify Potential Risks and Unforeseen Issues
3. Agile Team Perspective Shift
4. Tree of Thoughts Deep Dive
5. Hindsight is 20/20 Reflection
6. Persona-Pattern Hybrid (PM + Risk Analysis)
7. Innovation Tournament (alternate MVP scopes)
8. Proceed / No Further Actions
9. Proceed / No Further Actions

Select 0-8 or 9, or type feedback/questions. 