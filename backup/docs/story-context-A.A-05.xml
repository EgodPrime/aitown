<?xml version="1.0" encoding="utf-8"?>
<StoryContext>
  <GeneratedBy>BMad story-context workflow (non-interactive)</GeneratedBy>
  <GeneratedAt>2025-10-08T00:00:00Z</GeneratedAt>
  <Project>aitown</Project>
  <Epic id="A">NPC 管理与展示</Epic>
  <Story id="A-05">
    <Title>Story 1.5: NPC Prompt 提示库与示例 Prompt + 删除 NPC</Title>
    <Status>Draft</Status>
    <Author>Egod</Author>
    <Points>5</Points>
    <Priority>Medium</Priority>
    <MarkdownPath>docs/stories/story-1.5.md</MarkdownPath>
  </Story>

  <Sources>
    <File path="docs/stories/story-1.5.md" role="story_markdown"/>
    <File path="docs/prd.md" role="prd"/>
    <File path="docs/epic-stories.md" role="epic_index"/>
  </Sources>

  <AcceptanceCriteria>
    <Item>提供只读示例 prompt 库（静态文件: docs/prompt-templates.json 或 GET /prompt-templates），至少 6 条示例，示例不得包含私有凭证或密钥。</Item>
    <Item>示例 prompt 在服务启动时可加载，或通过只读端点按需读取，前端可显示供玩家选择。</Item>
    <Item>DELETE /npc/{id} 仅允许资源所有者或管理员执行；成功返回 200，并向订阅客户端广播 npc_deleted；删除需从内存活动列表移除 NPC 并在事件日志中保留审计记录（actor, npc_id, timestamp）。</Item>
    <Item>删除后对该 id 的 GET /npc/{id} 应返回 404 或标记为已删除的状态。</Item>
  </AcceptanceCriteria>

  <PRDHighlights>
    <Item>玩家只能管理一个 NPC，并且只能编辑或删除自己拥有的 NPC（通过 player_id 验证）。</Item>
    <Item>Prompt 更新在玩家界面可立即看到，但行为变化在后端仿真步中逐步生效（非即时保证）。</Item>
    <Item>系统采用事件驱动（Event Bus）：行为生成写入事件日志并驱动内存快照更新与广播 state_update。</Item>
    <Item>LLM Adapter 与本地回退策略（5s 超时）用于保障仿真稳定性。</Item>
  </PRDHighlights>

  <ImplementationNotes>
    <Note>路由实现建议：在 `src/routes/npc.ts` 提供 `GET /prompt-templates`（只读）与 `DELETE /npc/:id`；在 `src/services/npcService.ts` 实现删除逻辑并通过 `memoryRepo` 追加事件日志。</Note>
    <Note>权限：复用现有 player_id 中间件；缺失则返回 401；非所有者返回 403；管理员可执行删除。</Note>
    <Note>测试：添加集成测试覆盖 prompt-templates 端点返回、DELETE 权限、事件日志与 WebSocket 广播。</Note>
  </ImplementationNotes>

  <References>
    <Reference path="docs/prd.md" description="产品需求文档"/>
    <Reference path="docs/epic-stories.md" description="Epic 与 Stories 索引"/>
    <Reference path="docs/stories/story-1.5.md" description="Story 草稿"/>
  </References>

</StoryContext>
