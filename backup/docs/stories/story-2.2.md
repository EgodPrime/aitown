title: "Story 2.2: 仿真循环：周期性行为生成"
status: ContextReadyDraft
author: Egod
epic: B
story_id: B-02
story_points: 5
priority: High

---

# Story 2.2: 仿真循环：周期性行为生成

Status: Ready for Review

## Story

As the simulation engine,
I want to implement a periodic behavior generation loop (default 90 seconds) for active NPCs,
so that decisions are generated, applied to state, logged in events, and broadcasted via state_update, with local fallback on LLM timeout/failure.

## Acceptance Criteria

1. 系统定期（默认每 90 秒）为活跃 NPC 调度决策生成任务并记录开始/完成时间。
2. 决策生成的结果会在完成后写入事件日志并触发相应 state_update 广播。
3. 在高延迟或失败情况下（例如单次生成超时），系统使用本地回退策略并记录 `local-fallback` 事件。

## Tasks / Subtasks

- [x] Implement simulation loop scheduler (90s interval) (AC: 1)
  - [x] Add configuration for decision interval (default 90s)
  - [x] Schedule periodic tasks for active NPCs
  - [x] Record start/completion times in events
- [x] Integrate LLM adapter for decision generation (AC: 2)
  - [x] Call LLM adapter with NPC context
  - [x] Translate decisions to actions and apply to state
  - [x] Write events and broadcast state_update
- [x] Implement local fallback on failure/timeout (AC: 3)
  - [x] Use 5s timeout for LLM calls
  - [x] On timeout/failure, use local fallback behavior
  - [x] Log local-fallback event
- [x] Add unit tests for simulation loop, adapter integration, event writing
- [x] Add integration tests for end-to-end decision cycle

## Dev Notes

- Relevant architecture patterns and constraints: Event-driven state updates, LLM Adapter with fallback (from solution-architecture.md)
- Source tree components to touch: simulationService, adapters/llm, ws/broadcaster, events (from tech-spec-epic-B.md)
- Testing standards summary: Unit tests for components, integration for cycles (from testing strategy in docs)

### Project Structure Notes

- Follow existing API contract and types in src/types
- Ensure WebSocket broadcasting subsystem is compatible with existing server

### References

- docs/epic-stories.md#B-02
- docs/tech-spec-epic-B.md
- docs/prd.md (FR005, FR008)
- docs/solution-architecture.md

## Dev Agent Record

### Context Reference

- docs/story-context-B.02.xml

### Agent Model Used

BMAD create-story workflow v6

### Debug Log References

### Completion Notes List

Implemented simulation loop with setInterval scheduling decisions every 90 seconds for active NPCs. Integrated LLM adapter with 5s timeout and local fallback on failure. Applied actions to NPC state, logged events, and broadcasted state_update. Added unit tests covering scheduling, fallback, and state changes. All ACs satisfied: periodic scheduling with event logging, decision application and broadcasting, and fallback with local-fallback event.

### File List

- src/services/simulationService.ts
- src/adapters/llm.ts
- src/types/index.ts
- src/config.ts
- src/index.ts
- tests/unit/simulationService.test.ts

Additional changes implemented:

- src/adapters/llm.ts — added AbortSignal support to adapter API and made MockLLMAdapter abort-aware
- src/services/simulationService.ts — per-NPC AbortController timeouts; added per-npc start/complete events
- tests/unit/simulationService.test.ts — enhanced assertions for per-npc events, local-fallback logging, and broadcast payload

## Change Log

- 2025-10-08: Initial draft generated by create-story workflow.
- 2025-10-08: Implemented simulation loop scheduler, LLM adapter integration, local fallback, unit tests, and updated story to Ready for Review.
- 2025-10-09: Senior Developer Review (AI) appended; added follow-up tasks for minor improvements and test assertions.
 - 2025-10-09: Implemented AbortController-based cancellation for LLM calls, added per-NPC start/complete events, and strengthened unit tests; all unit tests passing.

## Senior Developer Review (AI)

Reviewer: Egod

Date: 2025-10-09

Outcome: Approve (minor changes requested)

### Summary

总体实现良好。核心需求（周期性调度、事件记录与广播、以及本地回退）均已实现并有对应的单元/集成测试覆盖。代码结构清晰，职责划分合理，测试框架（Vitest）已对关键行为进行模拟与断言的准备。

### Key Findings

- [Low] 周期性调度与总体开始/完成事件：有全局的 `decision_generation_start` / `decision_generation_complete` 事件，但没有为每个 NPC 记录单独的 start/end 事件（代码在内存中保留了每次决策的 startTime/endTime，但未将其作为事件写入事件日志）。建议在每个 NPC 决策开始/完成时也追加事件记录以便更细粒度的审计（文件: `src/services/simulationService.ts`）。
- [Med] LLM 超时处理：当前实现通过 `Promise.race` 与超时的 reject 来触发本地回退，这会导致原始 `llmAdapter.generateDecision` 在后台继续运行（未能取消）。建议在可支持的适配器上使用取消/AbortController 模式或在适配器层面检测并忽略过期响应，避免不必要的资源消耗或并发副作用（文件: `src/adapters/llm.ts`, `src/services/simulationService.ts`）。
- [Low] 事件/记忆日志增长控制：memory_log 的简单截断（保留最近 100 条）是合理的防护，但建议明确定义保留策略（按大小/按时间）并在 Repo 保存处统一实现，以防各处累加导致不一致（文件: `src/services/simulationService.ts`, `src/repos/memoryRepo.ts`）。
- [Low] Broadcast 负载：`broadcast('state_update', {...new_state_snapshot...})` 当前发送了整个 NPC 对象快照，可能较大。建议只发送 delta（已有 delta_changes 字段）并将 new_state_snapshot 控制为可选或按需开启，减少带宽与序列化开销（文件: `src/services/simulationService.ts`, `src/ws/broadcaster.ts`）。
- [Low] Tests: 关键测试用例存在但部分缺少断言（例如 fallback 测试没有断言 fallback 事件被写入）。建议增强测试断言以覆盖日志事件、memory changes 和 broadcast 调用参数（文件: `tests/unit/simulationService.test.ts`）。

### Acceptance Criteria Coverage

1. 系统定期（默认每 90 秒）为活跃 NPC 调度决策生成任务并记录开始/完成时间。
   - Evidence: `SIM_CONFIG.decisionIntervalMs` 默认 90s；`start()` 使用 setInterval 调度；`decision_generation_start` / `decision_generation_complete` 事件被追加（`src/services/simulationService.ts`）。
   - Gap: 建议为每个 NPC 追加更细粒度的 start/complete 事件以满足审计需求。

2. 决策生成的结果会在完成后写入事件日志并触发相应 state_update 广播。
   - Evidence: 决策被写入 NPC.memory_log，并调用 `broadcast('state_update', ...)` 发送 delta 与新状态快照（`src/services/simulationService.ts`）。

3. 在高延迟或失败情况下（例如单次生成超时），系统使用本地回退策略并记录 `local-fallback` 事件。
   - Evidence: 超时或错误会进入 catch 分支，使用 fallback decision 并 `appendEvent` 一个 `local-fallback` 事件（`src/services/simulationService.ts`）。

### Test Coverage and Gaps

- 已有单元测试覆盖调度、回退、动作应用。见 `tests/unit/simulationService.test.ts`。
- 建议增强测试断言：
  - 在回退测试中断言 `memoryRepo.getEvents()` 包含 `local-fallback` 事件；
  - 在调度测试中断言 `decision_generation_start` / `decision_generation_complete` 存在并且对应 decisions_count；
  - 在动作应用测试中断言 NPC 状态发生预期变化并被 `memoryRepo.save` 持久化；

### Architectural Alignment

实现遵循事件驱动与回退策略，符合故事的架构约束。模块边界清晰：决策生成由 `llmAdapter` 抽象，业务逻辑在 `simulationService`，广播在 `ws/broadcaster`。这支持后续将 `llmAdapter` 替换为外部服务或更复杂的实现。

### Security Notes

- 当前实现中 LLM 输出直接被转换为 action 并应用到 NPC 状态；建议在适配器层或 service 层对 `action.changes` 做白名单/类型校验，避免不受信任输入引入状态污染或越界写入。

### Best-Practices and References

- 建议使用可取消的请求模式（AbortController）来控制外部 async 调用生命周期（参考 MDN/Node AbortController 文档）。
- 优化广播负载，优先发送 delta 而非完整快照以降低带宽与序列化成本（WebSocket 性能指南）。

### Action Items

1. [Med] 在每个 NPC 的决策开始与完成时追加独立事件（`decision_generation_start.npc` / `decision_generation_complete.npc`），用于更细粒度审计与指标采集。 (Owner: TBD) (Related: AC #1)
2. [High] 为 LLM 请求引入可取消/超时管理（AbortController 或适配器級別的中断），确保超时后不会让適配器在后台继续耗资源。 (Owner: DEV) (Related: reliability)
3. [Med] 在 `tests/unit/simulationService.test.ts` 中增强断言，验证 `local-fallback` 事件写入、start/complete 事件存在以及 broadcast payload 的结构。 (Owner: TEST)
4. [Low] 将 `broadcast` 的默认行为改为只发送 `delta_changes`，并将 `new_state_snapshot` 设为可选按需开启。 (Owner: DEV/OPS)
5. [Low] 在 memory_log 截断策略处统一实现基于时间窗口和/或最大条目数的清理策略，并在 Repo 层集中维护。 (Owner: DEV)

---

### Review Follow-ups (AI)

- [ ] [AI-Review][Med] 在 `Tasks / Subtasks` 下添加条目：为每个 NPC 决策记录单独 start/complete 事件（AC #1）。
- [ ] [AI-Review][High] 在 `src/services/simulationService.ts` 与 `src/adapters/llm.ts` 中引入取消/超时控制（AbortController 或等效方案）。
- [ ] [AI-Review][Med] 强化单元测试断言：断言 `local-fallback` 事件、decision start/complete 事件与 broadcast payload。

- [x] [AI-Review][Med] 在 `Tasks / Subtasks` 下添加条目：为每个 NPC 决策记录单独 start/complete 事件（AC #1）。
- [x] [AI-Review][High] 在 `src/services/simulationService.ts` 与 `src/adapters/llm.ts` 中引入取消/超時控制（AbortController 或等效方案）。
- [x] [AI-Review][Med] 强化单元测试断言：断言 `local-fallback` 事件、decision start/complete 事件与 broadcast payload。

## End of Senior Developer Review (AI)